<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IA Facial - Fix Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: white; text-align: center; font-family: sans-serif; }
        .cam-container { width: 95%; max-width: 400px; margin: 20px auto; border: 4px solid #00d1b2; border-radius: 15px; overflow: hidden; background: #000; }
        canvas { width: 100%; height: auto; display: block; }
        #resultado { font-size: 2rem; color: #00d1b2; font-weight: bold; margin-top: 15px; }
        .alert { margin: 15px; border-radius: 50px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <h2 class="mt-4">Detector de Rostros</h2>
    <div id="status" class="alert alert-warning">Cargando modelo inteligente...</div>
    
    <div class="cam-container">
        <canvas id="canvas"></canvas>
    </div>

    <div id="resultado">Esperando...</div>

    <video id="video" playsinline autoplay style="display: none;"></video>
    <canvas id="hidden_canvas" width="150" height="150" style="display: none;"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

    <script>
        let modelo = null;
        const PERSONAS = ["Daniela", "Fajardo", "Gabriel", "Idney", "Jesús", "Kevin", "Victor"];

        async function iniciar() {
            // 1. Configurar Cámara
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                const video = document.getElementById("video");
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    const canvas = document.getElementById("canvas");
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    renderLoop();
                };
            } catch (err) {
                document.getElementById("status").innerText = "Error de cámara. Usa HTTPS.";
            }

            // 2. Cargar y Parchear Modelo (Solución Keras 3)
            try {
                const response = await fetch('./model.json');
                const modelJson = await response.json();

                // FUNCIÓN DE PARCHEO PROFUNDO
                const patchLayer = (layer) => {
                    if (layer.config) {
                        // Si falta el shape de entrada, lo inyectamos
                        if (!layer.config.batch_input_shape) {
                            layer.config.batch_input_shape = [null, 150, 150, 3];
                        }
                        // Si hay sub-capas (Functional models), las parcheamos también
                        if (layer.config.layers) {
                            layer.config.layers.forEach(patchLayer);
                        }
                    }
                };

                if (modelJson.modelTopology && modelJson.modelTopology.model_config) {
                    const modelConfig = modelJson.modelTopology.model_config;
                    const layers = modelConfig.config.layers || modelConfig.config.layers_configs;
                    if (layers) layers.forEach(patchLayer);
                }

                // Cargar usando la nueva API de un solo objeto
                modelo = await tf.loadLayersModel(tf.io.fromMemory(modelJson));

                document.getElementById("status").innerText = "¡IA Lista! ✅";
                document.getElementById("status").className = "alert alert-success";
                predecir();
            } catch (err) {
                console.error("Error cargando el modelo:", err);
                document.getElementById("status").innerText = "Error: El modelo no es compatible con la web.";
            }
        }

        function renderLoop() {
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0);
            requestAnimationFrame(renderLoop);
        }

        async function predecir() {
            if (modelo) {
                const canvas = document.getElementById("canvas");
                const hidden = document.getElementById("hidden_canvas");
                const hCtx = hidden.getContext("2d");
                
                // Recortar y ajustar a 150x150
                hCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, 150, 150);

                const tensor = tf.tidy(() => {
                    return tf.browser.fromPixels(hidden)
                        .toFloat()
                        .div(255)
                        .expandDims(0);
                });

                const pred = await modelo.predict(tensor).data();
                const max = Math.max(...pred);
                const index = pred.indexOf(max);

                document.getElementById("resultado").innerText = max > 0.6 ? PERSONAS[index] : "Detectando...";
            }
            setTimeout(predecir, 500);
        }

        window.onload = iniciar;
    </script>
</body>
</html>
