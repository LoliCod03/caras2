<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IA Facial - Versión Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: white; text-align: center; font-family: sans-serif; }
        .cam-container { width: 90%; max-width: 400px; margin: 20px auto; border: 4px solid #00d1b2; border-radius: 15px; overflow: hidden; background: #000; }
        canvas { width: 100%; height: auto; display: block; }
        #resultado { font-size: 2rem; color: #00d1b2; font-weight: bold; margin-top: 15px; }
        .alert { margin: 15px; border-radius: 50px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <h2 class="mt-4">Reconocedor Facial</h2>
    <div id="status" class="alert alert-warning">Cargando sistema...</div>
    
    <div class="cam-container">
        <canvas id="canvas"></canvas>
    </div>

    <div id="resultado">Esperando...</div>

    <video id="video" playsinline autoplay style="display: none;"></video>
    <canvas id="hidden_canvas" width="150" height="150" style="display: none;"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

    <script>
        let modelo = null;
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        const PERSONAS = ["Daniela", "Fajardo", "Gabriel", "Idney", "Jesús", "Kevin", "Victor"];

        async function iniciar() {
            // 1. CÁMARA (Configuración flexible para evitar "Device not found")
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    renderizar();
                };
            } catch (err) {
                document.getElementById("status").innerText = "Error Cámara: Prueba en HTTPS o cambia de navegador";
                console.error(err);
            }

            // 2. MODELO (Parche de un solo argumento para tf.io.fromMemory)
            try {
                const response = await fetch('./model.json');
                const rawJson = await response.json();

                // Parcheamos la estructura para que TFJS no se queje
                if (rawJson.modelTopology && rawJson.modelTopology.model_config) {
                    const layers = rawJson.modelTopology.model_config.config.layers;
                    if (layers && layers[0]) {
                        // Forzamos el nombre que TFJS busca
                        layers[0].config.batch_input_shape = layers[0].config.batch_shape || [null, 150, 150, 3];
                    }
                }

                // Consolidamos en un solo argumento tipo ModelArtifacts
                const modelArtifacts = {
                    modelTopology: rawJson.modelTopology,
                    format: rawJson.format,
                    generatedBy: rawJson.generatedBy,
                    convertedBy: rawJson.convertedBy,
                    weightsManifest: rawJson.weightsManifest
                };

                // Cargamos usando la ruta actual para los .bin
                const path = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                modelo = await tf.loadLayersModel(tf.io.fromMemory(modelArtifacts), { weightPathPrefix: path });

                document.getElementById("status").innerText = "IA Lista ✅";
                document.getElementById("status").className = "alert alert-success";
                predecir();
            } catch (err) {
                document.getElementById("status").innerText = "Error Modelo: Revisa consola";
                console.error("Error crítico:", err);
            }
        }

        function renderizar() {
            ctx.drawImage(video, 0, 0);
            requestAnimationFrame(renderizar);
        }

        async function predecir() {
            if (modelo) {
                const hidden = document.getElementById("hidden_canvas");
                const hCtx = hidden.getContext("2d");
                hCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, 150, 150);

                const tensor = tf.tidy(() => {
                    return tf.browser.fromPixels(hidden).toFloat().div(255).expandDims(0);
                });

                const pred = await modelo.predict(tensor).data();
                const max = Math.max(...pred);
                const index = pred.indexOf(max);

                document.getElementById("resultado").innerText = max > 0.65 ? PERSONAS[index] : "...";
            }
            setTimeout(predecir, 500);
        }

        window.onload = iniciar;
    </script>
</body>
</html>
